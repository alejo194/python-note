ORMå…¨ç§°â€œObject Relational Mappingâ€ï¼Œå³å¯¹è±¡-å…³ç³»æ˜ å°„ï¼Œå°±æ˜¯æŠŠå…³ç³»æ•°æ®åº“çš„ä¸€è¡Œæ˜ å°„ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç±»å¯¹åº”ä¸€ä¸ªè¡¨ï¼Œè¿™æ ·ï¼Œå†™ä»£ç æ›´ç®€å•ï¼Œä¸ç”¨ç›´æ¥æ“ä½œSQLè¯­å¥ã€‚

è¦ç¼–å†™ä¸€ä¸ªORMæ¡†æ¶ï¼Œæ‰€æœ‰çš„ç±»éƒ½åªèƒ½åŠ¨æ€å®šä¹‰ï¼Œå› ä¸ºåªæœ‰ä½¿ç”¨è€…æ‰èƒ½æ ¹æ®è¡¨çš„ç»“æ„å®šä¹‰å‡ºå¯¹åº”çš„ç±»æ¥ã€‚

è®©æˆ‘ä»¬æ¥å°è¯•ç¼–å†™ä¸€ä¸ªORMæ¡†æ¶ã€‚

ç¼–å†™åº•å±‚æ¨¡å—çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯å…ˆæŠŠè°ƒç”¨æ¥å£å†™å‡ºæ¥ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨è€…å¦‚æœä½¿ç”¨è¿™ä¸ªORMæ¡†æ¶ï¼Œæƒ³å®šä¹‰ä¸€ä¸ªUserç±»æ¥æ“ä½œå¯¹åº”çš„æ•°æ®åº“è¡¨Userï¼Œæˆ‘ä»¬æœŸå¾…ä»–å†™å‡ºè¿™æ ·çš„ä»£ç ï¼š
æœŸæœ›ä»£ç 

class User(Model):      #  Userç±»ï¼Œç»§æ‰¿Model
    # å®šä¹‰ç±»çš„å±æ€§åˆ°åˆ—çš„æ˜ å°„ï¼š å³è¾¹çš„ StringField(â€˜usernameâ€™),è¿™é‡ŒStringFieldæ˜¯ç±»ï¼Œç±»(â€˜usernameâ€™)æ˜¯è¾“å…¥__init__ç»‘å®šçš„å‚æ•°ï¼Œæ‰€ä»¥å¾—åˆ°çš„æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œæ­£å¥½å¯¹åº”value
    id = IntegerField('id')     # âš ï¸idç†è§£ä¸ºä¸€ä¸ªå˜é‡ä¸å¥½ï¼Œidç†è§£æˆä¸€ä¸ªkeyæœ€æ°å½“ï¼Œ=å³è¾¹çš„åˆ™æ˜¯valueï¼Œè¿™é‡Œå¯¹åº”çš„å°±æ˜¯æ•°æ®åº“å­—å…¸çš„idæ•°æ®
    name = StringField('username')    # nameæ˜¯ç±»å±æ€§ï¼Œå…·ä½“å¯å‚è€ƒç±»å±æ€§ä¸å®ä¾‹å±æ€§å®šä¹‰ï¼Œç±»è°ƒç”¨å±æ€§å°±æ˜¯User.name 
    email = StringField('email')       # id name email password å‡æ˜¯Userçš„å±æ€§ï¼ŒUserçš„å®ä¾‹å¯ä»¥ç›´æ¥è°ƒç”¨
    password = StringField('password')  # User().name = StringField(â€˜usernameâ€™),ç›´æ¥è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”ä¸€ä¸ªuserçš„è¡¨ï¼Œè¡¨é‡Œçš„nameå«SF()

# åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼š
u = User(id=12345, name='Michael', email='test@orm.org', password='my-pwd')     # âš ï¸å¯¹ç…§è¿™ä¸ªæ•ˆæœå¯ä»¥æƒ³é€šä¸€äºŒäº†
# ä¿å­˜åˆ°æ•°æ®åº“ï¼š
u.save()
å…¶ä¸­ï¼Œçˆ¶ç±»Modelå’Œå±æ€§ç±»å‹StringFieldã€IntegerFieldæ˜¯ç”±ORMæ¡†æ¶æä¾›çš„ï¼Œå‰©ä¸‹çš„é­”æœ¯æ–¹æ³•æ¯”å¦‚save()å…¨éƒ¨ç”±metaclassè‡ªåŠ¨å®Œæˆã€‚è™½ç„¶metaclassçš„ç¼–å†™ä¼šæ¯”è¾ƒå¤æ‚ï¼Œä½†ORMçš„ä½¿ç”¨è€…ç”¨èµ·æ¥å´å¼‚å¸¸ç®€å•ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°±æŒ‰ä¸Šé¢çš„æ¥å£æ¥å®ç°è¯¥ORMã€‚

é¦–å…ˆæ¥å®šä¹‰Fieldç±»ï¼Œå®ƒè´Ÿè´£ä¿å­˜æ•°æ®åº“è¡¨çš„å­—æ®µåå’Œå­—æ®µç±»å‹

class Field(object):    # å¯¹åº”æ•°æ®åº“ä¸­ä¿å­˜çš„å­—æ®µåå’Œå­—æ®µç±»å‹

    def __init__(self, name, column_type):     # æ·»åŠ __init__(self,name)æ–¹æ³•åï¼Œç±»çš„å®ä¾‹å¿…é¡»æ˜¯StringField(â€˜æŸnameâ€™)ï¼Œæ­£å¥½å‘¼åº”ä¸Šæ–¹çš„æœŸæœ›ä»£ç 
        self.name = name    # å­—æ®µå
        self.column_type = column_type    # å­—æ®µç±»å‹

    def __str__(self):   # è¾“å…¥print(xxx)ä¼šè‡ªåŠ¨è°ƒç”¨__str__,å®ƒä¸ºäº†ä½¿æ‰“å°ç»“æœæ›´å¥½çœ‹è€Œå·²ï¼ŒPython å®šä¹‰äº†__str__()å’Œ__repr__()ä¸¤ç§æ–¹æ³•ï¼Œ__str__()ç”¨äºæ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œè€Œ__repr__()ç”¨äºæ˜¾ç¤ºç»™å¼€å‘äººå‘˜ã€‚

        return '<%s:%s>' % (self.__class__.__name__, self.name)    # ä¸ä½¿ç”¨print(xxx)è€Œæ˜¯ç›´æ¥è¾“å…¥å®ä¾‹xxxï¼Œåˆ™è¯¥è¡Œä¸ä¼šæ‰“å°æ˜¾ç¤ºå‡ºæ¥ï¼Œçœ‹èµ·æ¥å°±å¾ˆä¸‘
åœ¨Fieldçš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥å®šä¹‰å„ç§ç±»å‹çš„Fieldï¼Œæ¯”å¦‚StringFieldï¼ŒIntegerFieldç­‰ç­‰ï¼š

class StringField(Field):     # âœŒï¸é€šè¿‡æ¯”å¯¹æµ‹è¯•ï¼ŒStringField.name = name, StringField.column_type = varchar(100).

    def __init__(self, name):     # å®ä¾‹å±æ€§ï¼Œ`å®ä¾‹.name`è°ƒç”¨
        super(StringField, self).__init__(name, 'varchar(100)')   # ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿsuperæœ€åè·Ÿçš„å‚æ•°æ˜¯(name,â€™varchar(100)â€™)ä¸€ä¸ªå˜é‡nameï¼Œä¸€ä¸ªå€¼ã€‚ä¸ºäº†å°±æ˜¯ä¸è®©äººå»ä¿®æ”¹ column_typeè¿™ä¸ªå‚æ•°è€Œå·²
         # âš ï¸superçš„ç”¨æ³•ï¼Œç»§æ‰¿çˆ¶ç±»çš„æ–¹æ³•è€Œè‡ªå·±æ— éœ€å®šä¹‰ï¼Œ super(StringFileld,self).__init__è¿™æ®µæ˜¯å¥—è·¯ï¼Œéƒ½ä¸€æ ·ï¼Œsuperåé¢è·Ÿçš„å­ç±»å+self,åªæœ‰æœ€åçš„(name,â€™varchar(100)â€™)è¡¨ç¤ºç»§æ‰¿çˆ¶ç±»çš„å“ªäº›å±æ€§
------------------------æµ‹è¯•------------------------------
In [67]: test = StringField('love')

In [68]: type(test)
Out[68]: __main__.StringField

In [70]: test.column_type
Out[70]: 'varchar(100)'

In [71]: test.name
Out[71]: 'love'
------------------------------------------------------------
class IntegerField(Field):       # âš ï¸å­ç±»ç»§æ‰¿è¿™äº›æ–¹æ³•

    def __init__(self, name):
        super(IntegerField, self).__init__(name, 'bigint')   # __init__()è¿™æ ·çš„å†™æ³•,å¯å‚è€ƒæˆ‘çš„superæ–‡ç« 

ä¸‹ä¸€æ­¥ï¼Œå°±æ˜¯ç¼–å†™æœ€å¤æ‚çš„ModelMetaclassäº†ï¼š(é‡ç‚¹ éš¾)
class ModelMetaclass(type):
    # å…ƒç±»å¿…é¡»å®ç°__new__æ–¹æ³•ï¼Œå½“ä¸€ä¸ªç±»æŒ‡å®šé€šè¿‡æŸå…ƒç±»æ¥åˆ›å»ºï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨è¯¥å…ƒç±»çš„__new__æ–¹æ³•
    # è¯¥æ–¹æ³•æ¥æ”¶4ä¸ªå‚æ•°
    # clsä¸ºå½“å‰å‡†å¤‡åˆ›å»ºçš„ç±»çš„å¯¹è±¡ 
    # nameä¸ºç±»çš„åå­—ï¼Œåˆ›å»ºUserç±»ï¼Œåˆ™nameä¾¿æ˜¯User
    # basesç±»ç»§æ‰¿çš„çˆ¶ç±»é›†åˆ,åˆ›å»ºUserç±»ï¼Œåˆ™baseä¾¿æ˜¯Model
    # ğŸ·attrså»–ç¥è¯´æ˜¯ç±»çš„æ–¹æ³•çš„é›†åˆï¼Œæ˜¯ç±»æ–¹æ³•ï¼ç±»æ–¹æ³•æ˜¯ä¸€ç§å‡½æ•°ï¼Œæ€ä¹ˆé›†åˆï¼Ÿæ‰€ä»¥é›†åˆçš„keyåº”æ˜¯æ–¹æ³•å,è€Œvalueåº”è¯¥æ˜¯ Fieldç±» !!!å¯çœ‹æœ€ä¸‹æ–¹çš„æ‰“å°ç»“æœ ï¼

    def __new__(cls, name, bases, attrs):    # æ–°å»ºnewï¼Œæ‰€ä»¥åé¢4ä¸ªå‚æ•°éƒ½æ˜¯ç±»ç›¸å…³çš„
        if name=='Model':
        # å› ä¸ºModelç±»æ˜¯åŸºç±»ï¼Œæ‰€ä»¥æ’é™¤æ‰ï¼Œå¦‚æœä½ print(name)çš„è¯ï¼Œä¼šä¾æ¬¡æ‰“å°å‡ºModel,User,Blogï¼Œå³
        # æ‰€æœ‰çš„Modelå­ç±»ï¼Œå› ä¸ºè¿™äº›å­ç±»é€šè¿‡Modelé—´æ¥ç»§æ‰¿å…ƒç±»
            return type.__new__(cls, name, bases, attrs)
        print('Found model: %s' % name)   # æ‰“å°æç¤º

        mappings = dict()   #  ç”¨äºå­˜å‚¨æ‰€æœ‰çš„å­—æ®µï¼Œä»¥åŠå­—æ®µå€¼ï¼Œæ³¨æ„æ˜¯dict(),è€Œä¸æ˜¯[ ]ï¼Œæ‰€ä»¥åé¢çš„è¯­æ³•æ‰èƒ½å®ç°,å‚è€ƒhttp://www.jianshu.com/p/2ecaddc66100
        for k, v in attrs.items():     # æ³¨æ„è¿™é‡Œattrsçš„keyæ˜¯å­—æ®µåï¼Œvalueæ˜¯å­—æ®µå®ä¾‹ï¼Œä¸æ˜¯å­—æ®µçš„å…·ä½“å€¼
            if isinstance(v, Field):       # ç­›é€‰ v,åˆ¤æ–­væ˜¯å¦æ˜¯Field
            # attrsåŒæ—¶è¿˜ä¼šæ‹¿åˆ°ä¸€äº›å…¶å®ƒç³»ç»Ÿæä¾›çš„ç±»å±æ€§ï¼Œæˆ‘ä»¬åªå¤„ç†è‡ªå®šä¹‰çš„ç±»å±æ€§ï¼Œæ‰€ä»¥åˆ¤æ–­ä¸€ä¸‹
            # isinstance æ–¹æ³•ç”¨äºåˆ¤æ–­væ˜¯å¦æ˜¯ä¸€ä¸ªField,åªå¤„ç†è‡ªå®šä¹‰çš„ç±»å±æ€§
                print('Found mapping: %s ==> %s' % (k, v))
                mappings[k] = v   # ç»æµ‹è¯•ï¼Œè¯­æ³•æ­£ç¡®ï¼Œattrså­—å…¸ç§»æ¤åˆ°mappingsé‡Œ
        for k in mappings.keys():    # mappings.keysä¼šæ‰“å°å‡ºæ‰€æœ‰çš„key
            attrs.pop(k)    # popåˆ é™¤k,åˆ é™¤mappingså«æœ‰çš„æ‰€æœ‰çš„å­—æ®µåï¼Œvæ˜¯å­—æ®µå®ä¾‹
        attrs['__mappings__'] = mappings # ä¿å­˜å±æ€§å’Œåˆ—çš„æ˜ å°„å…³ç³»ï¼ŒçŒœæµ‹æ˜¯mappingså·²ç»ç¡®å®šäº†ï¼Œæˆ‘æŠŠå®ƒèµ‹å€¼ç»™attrs[xxx]ï¼Œattrsæ˜¯å­—å…¸æ ¼å¼ï¼Œdict[x]æ˜¯å–å­—å…¸valueï¼Œå–å‡ºåï¼Œè¢«èµ‹å€¼ã€‚ç±»ä¼¼äº Student.name = jack,é‚£ä¹ˆStudentè¿™ä¸ªç±»å°±æœ‰äº†ä¸ªç±»å±æ€§ï¼Œå­ç±»å¯ç»§æ‰¿ã€‚
            # '__mappings__'æ˜¯å­—ç¬¦ä¸²ï¼Œå±äºæˆ‘ä»¬æƒ³è¦çš„å±æ€§ï¼Œå±æ€§å¾ˆå¤šï¼Œæƒ³è¦çš„å°±è¿™å‡ ä¸ªï¼Œå…¶ä»–å…¨popï¼Œattrsæ˜¯ç±»å±æ€§ï¼Œè‹¥æˆ‘ä»¬ä¿ç•™ï¼Œå®ä¾‹å±æ€§è¦†ç›–å±æ€§ï¼Œå®¹æ˜“é€ æˆé”™è¯¯
        attrs['__table__'] = name # å‡è®¾è¡¨åå’Œç±»åä¸€è‡´
            # ä»¥ä¸Šéƒ½æ˜¯è¦è¿”å›çš„ä¸œè¥¿äº†ï¼Œåˆšåˆšè®°å½•ä¸‹çš„ä¸œè¥¿ï¼Œå¦‚æœä¸è¿”å›ç»™è¿™ä¸ªç±»ï¼Œåˆè°ˆå¾—ä¸Šä»€ä¹ˆåŠ¨æ€åˆ›å»ºå‘¢ï¼Ÿ
            # åˆ°æ­¤ï¼ŒåŠ¨æ€åˆ›å»ºä¾¿æ¯”è¾ƒæ¸…æ™°äº†ï¼Œå„ä¸ªå­ç±»æ ¹æ®è‡ªå·±çš„å­—æ®µåä¸åŒï¼ŒåŠ¨æ€åˆ›å»ºäº†è‡ªå·±
            # ä¸Šé¢é€šè¿‡attrsè¿”å›çš„ä¸œè¥¿ï¼Œåœ¨å­ç±»é‡Œéƒ½èƒ½é€šè¿‡å®ä¾‹æ‹¿åˆ°ï¼Œå¦‚self
        return type.__new__(cls, name, bases, attrs)

#  ä¸€æ¬¡å¤ç›˜åçš„çŒœæƒ³ï¼šæˆ‘ä»¬å…ˆçœ‹æœ€ä¸Šæ–¹çš„Userï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„æ•ˆæœï¼Œä¹Ÿæ­£æ˜¯æˆ‘ä»¬ å…ƒç±» __new__æ–¹æ³• å¯ä»¥åˆ›å»ºçš„ç»“æœã€‚
 é‚£ä¹ˆï¼Œæˆ‘ä»¬æƒ³ï¼Œ__new__(cls, name, bases, attrs)é‡Œçš„attrså±æ€§åº”è¯¥å¯¹åº”çš„æ˜¯å…ƒç±»å±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å…ƒç±»çš„attrsä½œä¸ºå­ç±»æ˜¯å¯ä»¥ç»§æ‰¿çš„ã€‚
ä½†æ˜¯å…ƒç±»çš„å±æ€§ç»§æ‰¿è™½ç„¶å¯ä»¥ï¼Œå› ä¸ºåœ¨å…ƒç±»åŸºç¡€ä¸Šå®šä¹‰çš„å­ç±»å±æ€§åº”è¯¥æ˜¯åŠ¨æ€åˆ›å»ºçš„ï¼Œæ‰€ä»¥å±æ€§çš„åç§°å¯èƒ½ä¼šä¸åŒï¼Œè¿™ä¸ªå±æ€§åæ€ä¹ˆæ›´æ¢ï¼Ÿæˆ‘çŒœè¿™æ°æ°æ˜¯  attrs.pop(k) éœ€è¦åšçš„äº‹æƒ…ã€‚

#  å»–-æŠŠç±»çœ‹æˆæ˜¯metaclassåˆ›å»ºå‡ºæ¥çš„â€œå®ä¾‹â€
#   ç±»çš„æ–¹æ³•ï¼ˆç±»ä¸­defçš„å°±æ˜¯ç±»æ–¹æ³•ï¼Œå®ä¾‹ä¸­defçš„æ˜¯å‡½æ•°ï¼‰å°±æ˜¯ç±»å®ä¾‹çš„å±æ€§ã€‚
æ‰€ä»¥ï¼Œæˆ‘ä»¬å®šä¹‰å…ƒç±»çš„æ–¹æ³•å°±æ˜¯ç»™ ç±»å¢åŠ å±æ€§ï¼Œè¿™æ ·ç±»é€šè¿‡ __new__ åˆ›å»ºåè‡ªå¸¦å±æ€§

#  å‚ç¬¬ä¸€å—ä»£ç Userï¼Œåœ¨åˆ›å»ºUserç±»æ—¶ï¼Œä¸­name == User, bases == Model, attrs æ˜¯å³å°†åˆ›å»ºçš„ç±» Userçš„ç±»å±æ€§
   ç›¸å½“äºåœ¨attrså¤„ä¼ å…¥äº†  å­—å…¸{  'id': IntegerField('id'),  'name': 'StringField('username'),  'email': StringField('email),  'password': StringField('password')    }ï¼›
   é‚£ä¹ˆfor k, v in attrs.items()ä¸­ï¼Œk ä¸º'id'ç­‰ï¼ˆèµ‹å€¼å·å·¦è¾¹ï¼‰ï¼Œ'v'ä¸ºIntegerField('id')å®ä¾‹ç­‰ï¼ˆèµ‹å€¼å·å³è¾¹ï¼‰ï¼›
   åœ¨å½“å‰ç±»ï¼ˆæ¯”å¦‚Userï¼‰ä¸­æŸ¥æ‰¾å®šä¹‰çš„ç±»çš„æ‰€æœ‰å±æ€§ï¼Œå¦‚æœæ‰¾åˆ°ä¸€ä¸ªFieldå±æ€§ï¼Œå°±æŠŠå®ƒä¿å­˜åˆ°ä¸€ä¸ª__mappings__çš„dictä¸­ï¼ŒåŒæ—¶ä»ç±»å±æ€§ä¸­åˆ é™¤è¯¥Fieldå±æ€§ï¼Œå¦åˆ™ï¼Œå®¹æ˜“é€ æˆè¿è¡Œæ—¶é”™è¯¯ï¼ˆå®ä¾‹çš„å±æ€§ä¼šé®ç›–ç±»çš„åŒåå±æ€§ï¼‰
ä»¥åŠåŸºç±»Modelï¼š

class Model(dict, metaclass=ModelMetaclass):
# è®©Modelç»§æ‰¿dict,ä¸»è¦æ˜¯ä¸ºäº†å…·å¤‡dictæ‰€æœ‰çš„åŠŸèƒ½ï¼Œå¦‚getæ–¹æ³•
# metaclassæŒ‡å®šäº†Modelç±»çš„å…ƒç±»ä¸ºModelMetaClass
    def __init__(self, **kw):    
        super(Model, self).__init__(**kw)       # ç»§æ‰¿çˆ¶ç±»çš„init 

    def __getattr__(self, key):    # å®šä¹‰å®ä¾‹å±æ€§ ç›®æ ‡ï¼šè·å¾—å±æ€§
        try:
            return self[key]
        except KeyError:
            raise AttributeError(r"'Model' object has no attribute '%s'" % key)
            # å®ç°__getattr__ä¸__setattr__æ–¹æ³•ï¼Œå¯ä»¥ä½¿å¼•ç”¨å±æ€§åƒå¼•ç”¨æ™®é€šå­—æ®µä¸€æ ·  å¦‚self['id']  
    def __setattr__(self, key, value):
        self[key] = value

    def save(self):
        fields = []
        params = []
        args = []
        for k, v in self.__mappings__.items():
            fields.append(v.name)
            params.append('?')
            args.append(getattr(self, k, None))
        sql = 'insert into %s (%s) values (%s)' % (self.__table__, ','.join(fields), ','.join(params))
        print('SQL: %s' % sql)
        print('ARGS: %s' % str(args))
å»–ç¥è§£è¯´ï¼š
å½“ç”¨æˆ·å®šä¹‰ä¸€ä¸ªclass User(Model)æ—¶ï¼ŒPythonè§£é‡Šå™¨é¦–å…ˆåœ¨å½“å‰ç±»Userçš„å®šä¹‰ä¸­æŸ¥æ‰¾metaclassï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ç»§ç»­åœ¨çˆ¶ç±»Modelä¸­æŸ¥æ‰¾metaclassï¼Œæ‰¾åˆ°äº†ï¼Œå°±ä½¿ç”¨Modelä¸­å®šä¹‰çš„metaclassçš„ModelMetaclassæ¥åˆ›å»ºUserç±»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œmetaclasså¯ä»¥éšå¼åœ°ç»§æ‰¿åˆ°å­ç±»ï¼Œä½†å­ç±»è‡ªå·±å´æ„Ÿè§‰ä¸åˆ°ã€‚

åœ¨ModelMetaclassä¸­ï¼Œä¸€å…±åšäº†å‡ ä»¶äº‹æƒ…ï¼š

æ’é™¤æ‰å¯¹Modelç±»çš„ä¿®æ”¹ï¼›

åœ¨å½“å‰ç±»ï¼ˆæ¯”å¦‚Userï¼‰ä¸­æŸ¥æ‰¾å®šä¹‰çš„ç±»çš„æ‰€æœ‰å±æ€§ï¼Œå¦‚æœæ‰¾åˆ°ä¸€ä¸ªFieldå±æ€§ï¼Œå°±æŠŠå®ƒä¿å­˜åˆ°ä¸€ä¸ª__mappings__çš„dictä¸­ï¼ŒåŒæ—¶ä»ç±»å±æ€§ä¸­åˆ é™¤è¯¥Fieldå±æ€§ï¼Œå¦åˆ™ï¼Œå®¹æ˜“é€ æˆè¿è¡Œæ—¶é”™è¯¯ï¼ˆå®ä¾‹çš„å±æ€§ä¼šé®ç›–ç±»çš„åŒåå±æ€§ï¼‰ï¼›

æŠŠè¡¨åä¿å­˜åˆ°__table__ä¸­ï¼Œè¿™é‡Œç®€åŒ–ä¸ºè¡¨åé»˜è®¤ä¸ºç±»åã€‚

åœ¨Modelç±»ä¸­ï¼Œå°±å¯ä»¥å®šä¹‰å„ç§æ“ä½œæ•°æ®åº“çš„æ–¹æ³•ï¼Œæ¯”å¦‚save()ï¼Œdelete()ï¼Œfind()ï¼Œupdateç­‰ç­‰ã€‚

æˆ‘ä»¬å®ç°äº†save()æ–¹æ³•ï¼ŒæŠŠä¸€ä¸ªå®ä¾‹ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚å› ä¸ºæœ‰è¡¨åï¼Œå±æ€§åˆ°å­—æ®µçš„æ˜ å°„å’Œå±æ€§å€¼çš„é›†åˆï¼Œå°±å¯ä»¥æ„é€ å‡ºINSERTè¯­å¥ã€‚

ç¼–å†™ä»£ç è¯•è¯•ï¼š

u = User(id=12345, name='Michael', email='test@orm.org', password='my-pwd')
u.save()
è¾“å‡ºå¦‚ä¸‹ï¼š

Found model: User
Found mapping: email ==> <StringField:email>   # æ³¨æ„âš ï¸ï¼Œä»ç»“æœå¯¼å‘ï¼Œk ä¸º email,v ä¸º<StringField:email> ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä¸Šé¢å¯¹k,vçš„åˆ¤æ–­éƒ½æ˜¯é”™çš„ï¼
Found mapping: password ==> <StringField:password>
Found mapping: id ==> <IntegerField:uid>
Found mapping: name ==> <StringField:username>
SQL: insert into User (password,email,username,id) values (?,?,?,?)
ARGS: ['my-pwd', 'test@orm.org', 'Michael', 12345]
# ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼šself.__tableæ˜¯User; .join(fields)æ˜¯(password,email,username,id); .join(params)æ˜¯(?,?,?,?)
# è¿›è€Œæ¨å¯¼fields.append(v.name)ï¼Œé‚£ä¹ˆv.nameå°±æ˜¯(password,email,username,id)ï¼›æ¨å¯¼args.append(getattr(self, k, None)),é‚£ä¹ˆagrså°±æ˜¯ getattråçš„key,ä¹Ÿå°±æ˜¯å±•ç¤ºkeyçš„å±æ€§ã€‚
# getattræ˜¯pythonä¸­è‡ªçœåŠŸèƒ½ï¼Œå³è¿”å›å±•ç¤ºå¯¹è±¡çš„å±æ€§

å¯ä»¥çœ‹åˆ°ï¼Œsave()æ–¹æ³•å·²ç»æ‰“å°å‡ºäº†å¯æ‰§è¡Œçš„SQLè¯­å¥ï¼Œä»¥åŠå‚æ•°åˆ—è¡¨ï¼Œåªéœ€è¦çœŸæ­£è¿æ¥åˆ°æ•°æ®åº“ï¼Œæ‰§è¡Œè¯¥SQLè¯­å¥ï¼Œå°±å¯ä»¥å®ŒæˆçœŸæ­£çš„åŠŸèƒ½
12æœˆ6æ—¥è¡¥å……
åœ¨ModelMetaclass é‡Œä¸ºä»€ä¹ˆä¼šæœ‰pop()è¿™æ ·çš„æ“ä½œï¼Ÿè¯·æ³¨æ„ï¼Œæˆ‘ä»¬åˆè¯†å®šä¹‰çš„æ—¶å€™ï¼Œdef __new__(cls, name, bases, attrs)ä¸­çš„ attrs æ˜¯ ç±»çš„æ–¹æ³•çš„é›†åˆ(å»–),ç±»çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å®ä¾‹çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæ–¹æ³•æœ‰å¾ˆå¤šç§ï¼Œä¸€éƒ¨åˆ†æ–¹æ³•æ˜¯è¦å½’çº³åˆ° æ•°æ®åº“ ä¸­ï¼Œå¹¶å»ºç«‹æ˜ å°„mappingsï¼Œæ‰€ä»¥å¯¹åº”çš„ åŸæ¥çš„ç±»çš„æ–¹æ³•çš„é›†åˆ attrs å°±è¯¥åˆ é™¤è¿™éƒ¨åˆ†å·²ç»å½’çº³çš„ï¼Œé˜²æ­¢å‡ºç°æ„å¤–ï¼Œå¯¼è‡´æ•°æ®åº“ æ•°æ®é”™è¯¯ã€‚
è¿™ä¸¤æ®µä»£ç é‡Œçš„véƒ½æ˜¯åœ¨ç±»Userå®šä¹‰æ—¶çš„å®ä¾‹åŒ–Fieldå¯¹è±¡ï¼Œæ³¨æ„vä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè™½ç„¶åœ¨ç¬¬äºŒæ®µä»£ç é‡Œè¾“å‡ºäº†å­—ç¬¦ä¸²ï¼Œé‚£æ˜¯åœ¨Fieldå®šä¹‰æ—¶æœ‰å‡½æ•°__strï¼Œè¾“å‡ºçš„æ—¶è¿™ä¸ªå‡½æ•°è¿”å›çš„å­—ç¬¦ä¸²ï¼Œæ‰€æœ‰çš„Fieldå®ä¾‹éƒ½å¯ä»¥è¿™æ ·è¿”å›å­—ç¬¦ä¸²

ç„¶åå‰©ä¸‹çš„ç±»æ–¹æ³•ï¼Œå† return type.__new__(cls, name, bases, attrs),æ­¤æ—¶çš„attrsé‡Œå·²ç»æ²¡æœ‰äº†é‚£äº›å±äº Field ç±»çš„ value äº†ã€‚

å»–å¤§-----åœ¨å½“å‰ç±»ï¼ˆæ¯”å¦‚Userï¼‰ä¸­æŸ¥æ‰¾å®šä¹‰çš„ç±»çš„æ‰€æœ‰å±æ€§ï¼Œå¦‚æœæ‰¾åˆ°ä¸€ä¸ªFieldå±æ€§ï¼Œå°±æŠŠå®ƒä¿å­˜åˆ°ä¸€ä¸ªmappingsçš„dictä¸­ï¼ŒåŒæ—¶ä»ç±»å±æ€§ä¸­åˆ é™¤è¯¥Fieldå±æ€§ï¼Œå¦åˆ™ï¼Œå®¹æ˜“é€ æˆè¿è¡Œæ—¶é”™è¯¯ï¼ˆå®ä¾‹çš„å±æ€§ä¼šé®ç›–ç±»çš„åŒåå±æ€§ï¼‰

è¿™é‡Œå»–å¤§åˆå½’ç»“ä¸ºç±»çš„å±æ€§ï¼Œå…¶å®åœ¨ä½¿ç”¨ä¸Šæ¥è¯´ï¼Œç±»å±æ€§ä¸ç±»æ–¹æ³•å·®åˆ«ä¸å¤§ï¼Œé™¤äº†ç±»å±æ€§ ç±»å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œé¢å¯¹å®ä¾‹æ—¶å®ƒä»¬ç”¨æ³•ç›¸åŒï¼Œå¦‚ä¸‹ï¼Œè¿˜çœŸçš„å¯ä»¥åˆ¤æ–­æ˜¯ç±»çš„å±æ€§ï¼Œæ‰€ä»¥ç°åœ¨åˆå§‹çš„ attrs ï¼Œæˆ‘å¯ä»¥è®¤ä¸ºå®ƒæ˜¯ç±»å±æ€§å’Œç±»æ–¹æ³•çš„åˆé›†

class User(Model):
    # å®šä¹‰ç±»çš„å±æ€§åˆ°åˆ—çš„æ˜ å°„ï¼š
    id = IntegerField('id')
    name = StringField('username')
ç½‘å‹æ€»ç»“ï¼š
1ã€è¿™ä¸¤æ®µä»£ç é‡Œçš„véƒ½æ˜¯åœ¨ç±»Userå®šä¹‰æ—¶çš„å®ä¾‹åŒ–Fieldå¯¹è±¡ï¼Œæ³¨æ„vä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè™½ç„¶åœ¨ç¬¬äºŒæ®µä»£ç é‡Œè¾“å‡ºäº†å­—ç¬¦ä¸²ï¼Œé‚£æ˜¯åœ¨Fieldå®šä¹‰æ—¶æœ‰å‡½æ•°__str__ï¼Œè¾“å‡ºçš„æ—¶è¿™ä¸ªå‡½æ•°è¿”å›çš„å­—ç¬¦ä¸²ï¼Œæ‰€æœ‰çš„Fieldå®ä¾‹éƒ½å¯ä»¥è¿™æ ·è¿”å›å­—ç¬¦ä¸²

     for k, v in self.__mappings__.items():
        fields.append(v.name)
        params.append('?')
        args.append(getattr(self, k, None))

     for k, v in attrs.items():
        if isinstance(v, Field):
            print('Found mapping: %s ==> %s' % (k, v))
            mappings[k] = v

2ã€è¿™ä¸¤æ®µä»£ç é‡Œâ€˜=â€™çš„æ„ä¹‰ä¸ä¸€æ ·ï¼Œç¬¬ä¸€æ®µæ˜¯èµ‹å€¼ï¼Œæ„å»ºclass ModelMetaclassé‡Œçš„attrsï¼Œç¬¬äºŒæ®µæ˜¯åœ¨æ„å»ºä¸€ä¸ªdict,ä¹Ÿå°±æ˜¯class Model(dict, metaclass=ModelMetaclass)é‡Œç”¨åˆ°çš„**kw
class User(Model):

# å®šä¹‰ç±»çš„å±æ€§åˆ°åˆ—çš„æ˜ å°„ï¼š
id = IntegerField('id')
name = StringField('username')
email = StringField('email')
password = StringField('password')
u = User(id=12345, name='Michael', email='test@orm.org', password='my-pwd')

3ã€è¿™ä¸¤æ®µä»£ç ä¸­å…³äºsuperçš„ç”¨æ³•è¡¨ç¤ºè°ƒç”¨çˆ¶å‡½æ•°çš„__init__æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ç±»çš„å®ä¾‹
def __init__(self, name):
    super(StringField, self).__init__(name, 'varchar(100)')

def __init__(self, **kw):
    super(Model, self).__init__(**kw)

4ã€è¿™æ®µä»£ç ï¼Œå¯ä»¥çŸ¥é“Userçš„ä»»ä½•å®ä¾‹å·²ç»æ²¡æœ‰å±æ€§id,name,email,passwordäº†ï¼Œä¸è¿‡æœ‰å±æ€§__mappings__ï¼Œè¿™é‡Œä¿å­˜äº†id,name,email,passwordçš„ä¿¡æ¯ï¼Œè¿˜æœ‰__table__ä¿å­˜äº†ç±»åä¹Ÿå°±æ˜¯æ•°æ®åº“çš„è¡¨åï¼Œç„¶åè¿˜æœ‰å¯¹åº”è¡¨æ¯ä¸€è¡Œä¿¡æ¯çš„çš„dictï¼Œå¦‚id=12345, name='Michael', email='test@orm.org', password='my-pwd'
    for k in mappings.keys():
        attrs.pop(k)
    attrs['__mappings__'] = mappings   # ä¿å­˜å±æ€§å’Œåˆ—çš„æ˜ å°„å…³ç³»
    attrs['__table__'] = name          # å‡è®¾è¡¨åå’Œç±»åä¸€è‡´
5ã€å†æ¬¡åœ¨è¯„è®ºé‡Œçœ‹åˆ°Michael Liaoçš„å›å¤ï¼Œç»ˆäºç®—æ˜¯æ˜ç™½è¿™å¥è¯äº†ï¼

metaclass è´Ÿè´£åˆ›å»ºç±»ï¼Œç±» è´Ÿè´£åˆ›å»ºå®ä¾‹---å»–å¤§
